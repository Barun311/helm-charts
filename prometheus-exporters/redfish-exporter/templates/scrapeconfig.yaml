apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: {{ include "fullName" . }}
{{- $values := .Values.redfish_exporter -}}

{{- if $values.enabled }}
  namespace: {{ $values.namespace }}
  labels:
    prometheus: {{ required "$values.prometheus missing" $values.prometheus }}
    app.kubernetes.io/name: {{ include "fullName" . }}

spec:
- job_name: 'redfish/bm'
  params:
    job: [redfish/bm]
  scrape_interval: {{$values.scrapeInterval}}
  scrape_timeout: {{$values.scrapeTimeout}}
  http_sd_configs:
    - url: {{ $values.http_sd_configs.netbox_production_url }}/devices/?custom_labels=job=redfish/bm&target=mgmt_only&status=active&role=server&tenant=converged-cloud&platform=ironic&tag__n=no-redfish&region={{ .Values.global.region }}
      refresh_interval: {{ $values.http_sd_configs.refresh_interval }}
  metrics_path: /redfish
  relabel_configs:
    - source_labels: [job]
      regex: redfish/bm
      action: keep
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: redfish-exporter:{{$values.listen_port}}

- job_name: 'redfish/cp'
  params:
    job: [redfish/cp]
  scrape_interval: {{$values.scrapeInterval}}
  scrape_timeout: {{$values.scrapeTimeout}}
  http_sd_configs:
    - url: {{ $values.http_sd_configs.netbox_production_url }}/devices/?custom_labels=job=redfish/cp&target=mgmt_only&status=active&role=server&tenant=converged-cloud&platform=coreos&tag__n=no-redfish&region={{ .Values.global.region }}
      refresh_interval: {{ $values.http_sd_configs.refresh_interval }}
  metrics_path: /redfish
  relabel_configs:
    - source_labels: [job]
      regex: redfish/cp
      action: keep
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: redfish-exporter:{{$values.listen_port}}
    - source_labels: [__meta_serial]
      target_label: server_serial

- job_name: 'redfish/bb'
  params:
    job: [redfish/bb]
  scrape_interval: {{$values.scrapeInterval}}
  scrape_timeout: {{$values.scrapeTimeout}}
  http_sd_configs:
    - url: {{ $values.http_sd_configs.netbox_production_url }}/devices/?custom_labels=job=redfish/bb&target=mgmt_only&status=active&role=server&tenant=converged-cloud&platform=vmware-esxi&tag__n=no-redfish&region={{ .Values.global.region }}
      refresh_interval: {{ $values.http_sd_configs.refresh_interval }}
  metrics_path: /redfish
  relabel_configs:
    - source_labels: [job]
      regex: redfish/bb
      action: keep
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: redfish-exporter:{{$values.listen_port}}
{{- end }}

{{- if $values.firmware.enabled }}
- job_name: 'redfish/fw'
  params:
    job: [redfish/fw]
  scrape_interval: {{$values.firmware.scrapeInterval}}
  scrape_timeout: {{$values.firmware.scrapeTimeout}}
  http_sd_configs:
    - url: {{ $values.http_sd_configs.netbox_production_url }}/devices/?custom_labels=job=redfish/fw&target=mgmt_only&status=active&role=server&tenant=converged-cloud&tag__n=no-redfish&region={{ .Values.global.region }}
      refresh_interval: {{ $values.http_sd_configs.refresh_interval }}
  metrics_path: /firmware
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: redfish-exporter:{{$values.listen_port}}
{{- end }}
