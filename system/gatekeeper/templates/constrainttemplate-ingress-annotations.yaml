apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: gkingressannotations
spec:
  crd:
    spec:
      names:
        kind: GkIngressAnnotations

  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package ingressannotations

        iro := input.review.object
        iro_support_group := object.get(iro, ["metadata", "labels", "cc/support-group"], "none")
        iro_service := object.get(iro, ["metadata", "labels", "cc/service"], "none")

        ingress_annotations = {k |
          iro.metadata.annotations[k]
          contains(k, "ingress.kubernetes.io")
        }

        # These annotations have been disabled due to CVE-2021-25742
        disabled_annotations = {
          "auth-snippet",
          "configuration-snippet",
          "server-snippet",
          "modsecurity-snippet",
        }

        violation[{"msg": msg}] {
          iro.kind == "Ingress"

          count(ingress_annotations) > 0
          found := {a |
            ingress_annotations[k]
            sL := split(k, "/")
            count(sL) == 2
            sL[1] == disabled_annotations[_]
            a = sL[1]
          }

          count(found) > 0
          msg := sprintf(
            "support-group=%s,service=%s: has disabled annotations: %s",
            [iro_support_group, iro_service, sort(found)]
          )
        }
